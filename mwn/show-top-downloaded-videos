#!/usr/bin/perl -w

use strict;
use Log::Log4perl qw(:easy);
use URI::Escape;

my $SITE     = "steven.hosting.localdomain";
my $HTTPS    = 0;
my $URI_PATH = "/download/video";
my $N        = 10;

Log::Log4perl->easy_init($INFO);

my $cur_time = time;
my ($cur_mday, $cur_month, $cur_year) = (localtime $cur_time)[3, 4, 5];
$cur_month++;
$cur_year += 1900;

my %udownloaded_last_30days = (); # unique number of computers
my %udownloaded_last_7days = ();
my %downloaded_last_30days = (); # number of files downloaded
my %downloaded_last_7days = ();
my %bytes_last_30days = ();
my %bytes_last_7days = ();

my %k7 = ();
my %k30 = ();

my $e_uri_path = quotemeta($URI_PATH);

my $time = $cur_time;
while (1) {
    my ($mday, $month, $year) = (localtime $time)[3, 4, 5];
    $month++;
    $year += 1900;

    my $file = sprintf "/s/%s/syslog/%s_access.%04d-%02d-%02d.log", $SITE, ($HTTPS ? "https" : "http"), $year, $month, $mday;
    if (-f $file) {
        DEBUG "Reading $file ...";
        open F, $file;
    } elsif (-f "$file.gz") {
        DEBUG "Reading $file.gz ...";
        open F, "zcat $file.gz |";
    } else {
        goto L1;
    }
    
    while (<F>) {
        my ($host, $date, $uri, $status, $bytes, $referer, $ua) =
            m#^(\S+) \S+ \S+ \[(.+?)\] "\S+ (\S+) HTTP/\d+\.\d+" (\d\d\d) (\d+) "(.*?)" "(.*?)"# or next;

        next unless $status == 200;
        next unless $bytes > 50_000_000;
        next unless $uri =~ m#^$e_uri_path/([^/]+)/\S+\.(rmvb|avi|mpe?g|mp4|mkv|dat)$#i;
        my $movtitle = uri_unescape($1);
        next unless $movtitle =~ /\(\d+\)/;

        $udownloaded_last_30days{$movtitle}++ unless $k30{$movtitle.$host}++;
        $downloaded_last_30days{$movtitle}++;
        $bytes_last_30days{$movtitle} += $bytes;
        if (($cur_time - $time) <= 7*86400) {
            $udownloaded_last_7days{$movtitle}++ unless $k7{$movtitle.$host}++;
            $downloaded_last_7days{$movtitle}++;
            $bytes_last_7days{$movtitle} += $bytes;
        }
    }

  L1:
    $time -= 86400;
    last if ($cur_time - $time) > 30*86400;
}

print "Subject: Top $N movies di $SITE per $cur_year-$cur_month-$cur_mday\n\n";
print "[b]7 (tujuh) hari terakhir:[/b]\n";
my $i = 1;
for (sort {
    ($udownloaded_last_7days{$b} <=> $udownloaded_last_7days{$a}) ||
    ($downloaded_last_7days{$b} <=> $downloaded_last_7days{$a}) ||
    ($bytes_last_7days{$b} <=> $bytes_last_7days{$a})
          }
     keys %downloaded_last_7days) {
    printf "%d. %s: %d file didownload oleh %d org (%.1fGB)\n",
        $i,
        ($i == 1 ? "[b]".$_."[/b]" : $_),
        $downloaded_last_7days{$_},
        $udownloaded_last_7days{$_},
        $bytes_last_7days{$_}/1024/1024/1024;
    last if $i++ >= $N;
}
print "\n";
print "[b]30 (tiga puluh) hari terakhir:[/b]\n";
$i = 1;
for (sort {
    ($udownloaded_last_30days{$b} <=> $udownloaded_last_30days{$a}) ||
    ($downloaded_last_30days{$b} <=> $downloaded_last_30days{$a}) ||
    ($bytes_last_30days{$b} <=> $bytes_last_30days{$a})
          }
     keys %downloaded_last_7days) {
    printf "%d. %s: %d file didownload oleh %d org (%.1fGB)\n",
        $i,
        ($i == 1 ? "[b]".$_."[/b]" : $_),
        $downloaded_last_30days{$_},
        $udownloaded_last_30days{$_},
        $bytes_last_30days{$_}/1024/1024/1024;
    last if $i++ >= $N;
}

print "\n";
my $hostname = `hostname`;
chomp($hostname);
print "(Generated by: $0 on $hostname at ".(scalar localtime).")";
