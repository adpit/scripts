#!/usr/bin/perl -w

use strict;
use App::Options (
    option => {
        counter_path => { type => 'string', required => 1,},
        phpbb2_post_profile => { type => 'string', required => 1, },
    },
);
use File::Slurp;

my $counter = read_file($App::options{counter_path})
    or die "Can't read counter file or counter not initialized: ".
    "$App::options{counter_path}";
chomp($counter);

my @revs;
for (`git log $counter..HEAD --pretty=oneline --reverse`) {
    /^(\w+) .+/ or die "Weird line in git log output: $_";
    push @revs, $1;
}

my $fail = 0;
for (@revs) {
    print "Posting rev $_ to phpBB2 forum ...\n";
    system "( echo 'Subject: commit message'; echo; echo -n '[code]'; ".
        "git log -1 -p $_; echo '[/code]' ) | ".
        "phpbb2-post --profile=$App::options{phpbb2_post_profile} --bbcode=1 -";
    if ($?) {
        warn "Posting failed (exit=$?), aborting ...";
        $fail++;
        last;
    } else {
        write_file($counter_path, $_);
    }
}
